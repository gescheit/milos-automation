# Lab03. Multivendor
networks:
  default:
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 172.20.0.0/24
        gateway: 172.20.0.1

  t1s1_net:
    name: t1s1_net
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.0.1.0/24

  t1s2_net:
    name: t1s2_net
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.0.2.0/24

  t2s1_net:
    name: t2s1_net
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.0.3.0/24

  t2s2_net:
    name: t2s2_net
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.0.4.0/24


  t3s1_net:
    name: t3s1_net
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.0.5.0/24

  t3s2_net:
    name: t3s2_net
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.0.6.0/24

  b1s1_net:
    name: b1s1_net
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.1.1.0/24

  b1s2_net:
    name: b1s2_net
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.1.2.0/24

  b2s1_net:
    name: b2s1_net
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.1.3.0/24

  b2s2_net:
    name: b2s2_net
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 10.1.4.0/24

x-ceos-defaults: &ceos-defaults
  image: arista-ceos:4.33.0F
  environment:
    - INTFTYPE=eth
    - MGMT_INTF=eth0
    - MAPETH0=1
    - ETBA=1
    - SKIP_ZEROTOUCH_BARRIER_IN_SYSDBINIT=1
    - CEOS=1
    - EOS_PLATFORM=ceoslab
    - container=docker
  privileged: true
  command: >
    /sbin/init
    systemd.setenv=INTFTYPE=eth
    systemd.setenv=MGMT_INTF=eth0
    systemd.setenv=MAPETH0=1
    systemd.setenv=ETBA=1
    systemd.setenv=SKIP_ZEROTOUCH_BARRIER_IN_SYSDBINIT=1
    systemd.setenv=CEOS=1
    systemd.setenv=EOS_PLATFORM=ceoslab
    systemd.setenv=container=docker

x-frr-defaults: &frr-defaults
  image: frrouting/frr:v8.4.1
  privileged: true
  networks:
    mgmt: {}
  cap_add:
    - NET_ADMIN
    - SYS_ADMIN
  sysctls:
    - net.ipv4.ip_forward=1
    - net.ipv4.conf.all.forwarding=1
    - net.ipv6.conf.all.forwarding=1
  tty: true
  command: >
    sh -c "apk add --no-cache openssh &&
           echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config &&
           echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config &&
           echo 'root:frr' | chpasswd &&
           adduser -h /home/annet -s /bin/sh -D annet &&
           echo -n 'annet:annet' | chpasswd &&
           ssh-keygen -A &&
           /usr/sbin/sshd &&
           /sbin/tini -- /usr/lib/frr/docker-start"

services:
  netbox:
    container_name: netbox
    hostname: netbox
    ports:
      - 8000:8080
    volumes:
      - ../topologies/lab03_multivendor/src:/home/ubuntu/src

  annet:
    container_name: annet
    hostname: annet
    volumes:
      - ../annet/config.yaml:/config.yaml
      - ../topologies/lab03_multivendor/src/lab_generators:/lab_generators
      - ../scripts:/home/ubuntu/scripts

  frr-r1:
    <<: *frr-defaults
    container_name: tor-1-1
    hostname: tor-1-1
    networks:
      default:
        ipv4_address: 172.20.0.110
      t1s1_net:
        ipv4_address: 10.0.1.110
      t1s2_net:
        ipv4_address: 10.0.2.110
    volumes:
      - ../topologies/lab01_frr-only-test/operational_configs/frr-r1.frr/frr.conf:/etc/frr/frr.conf
      - ../topologies/common_configs/frr_common_daemons:/etc/frr/daemons:ro
      - ../topologies/common_configs/frr_common_vtysh:/etc/frr/vtysh.conf:ro

  frr-r2:
    <<: *frr-defaults
    container_name: tor-1-2
    hostname: tor-1-2
    networks:
      default:
        ipv4_address: 172.20.0.111
      t2s1_net:
        ipv4_address: 10.0.3.111
      t2s2_net:
        ipv4_address: 10.0.4.111
    volumes:
      - ../topologies/lab01_frr-only-test/operational_configs/frr-r2.frr/frr.conf:/etc/frr/frr.conf
      - ../topologies/common_configs/frr_common_daemons:/etc/frr/daemons:ro
      - ../topologies/common_configs/frr_common_vtysh:/etc/frr/vtysh.conf:ro

  frr-r3:
    <<: *frr-defaults
    container_name: tor-1-3
    hostname: tor-1-3
    networks:
      default:
        ipv4_address: 172.20.0.112
      t3s1_net:
        ipv4_address: 10.0.5.112
      t3s2_net:
        ipv4_address: 10.0.6.112
    volumes:
      - ../topologies/lab01_frr-only-test/operational_configs/frr-r3.frr/frr.conf:/etc/frr/frr.conf
      - ../topologies/common_configs/frr_common_daemons:/etc/frr/daemons:ro
      - ../topologies/common_configs/frr_common_vtysh:/etc/frr/vtysh.conf:ro

  ceos-spine-1:
    <<: *ceos-defaults
    hostname: spine-1-1
    container_name: spine-1-1
    networks:
      default:
        ipv4_address: 172.20.0.113
      t1s1_net:
        ipv4_address: 10.0.1.113
      t2s1_net:
        ipv4_address: 10.0.3.113
      t3s1_net:
        ipv4_address: 10.0.5.113
      b1s1_net:
        ipv4_address: 10.1.1.114
      b2s1_net:
        ipv4_address: 10.1.3.114
    volumes:
      - ./operational_configs/ceos-r2.flash:/mnt/flash/

  ceos-spine-2:
    <<: *ceos-defaults
    hostname: spine-1-2
    container_name: spine-1-2
    networks:
      default:
        ipv4_address: 172.20.0.114
      t1s2_net:
        ipv4_address: 10.0.2.114
      t2s2_net:
        ipv4_address: 10.0.4.114
      t3s2_net:
        ipv4_address: 10.0.6.114
      b1s2_net:
        ipv4_address: 10.1.2.114
      b2s2_net:
        ipv4_address: 10.1.4.114
    volumes:
      - ./operational_configs/ceos-r3.flash:/mnt/flash/

  dynamips-lab:
    container_name: dynamips
    hostname: dynamips
    image: ubuntu:bionic
    tty: true
    volumes:
      - ../topologies/lab03_multivendor/src:/home/ubuntu/
      - ../scripts:/home/ubuntu/scripts
      - ../vm_images:/home/ubuntu/vm_images
    command: sh "/home/ubuntu/install.sh"
    cap_add:
          - net_admin
          - net_raw
          - sys_module
    devices: [/dev/net/tun:/dev/net/tun]
    networks:
      - default
      - b1s1_net
      - b1s2_net
      - b2s1_net
      - b2s2_net
