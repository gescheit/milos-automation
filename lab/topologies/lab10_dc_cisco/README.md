## Cisco DC Lab

### Introduction

This lab shows an example of DC networks. During the lab you will:

- Deploy the whole configuration on ToRs and spines
- Change the role of one of the ToRs to an unknown role and deploy configuration on the ToR and every spine
- Set maintenance tag on one of the spines and deploy configuration on the spine

Author:

- [Grigorii Solovev](https://github.com/gs1571)

### Objectives

- Understand main principles of writing Annet generators and mesh

### Preparation

Before you start, please put Cisco IOS image `c7200-jk9s-mz.124-13a.bin` into `lab/vm_images` directory.
The image is subject to a license agreement, so it cannot be distributed in the repository.

### Topology

![lab-topology](./images/topology.png)

**Naming:**

- Spine — `spine-<pod>-<plane>`
- ToR — `tor-<pod>-<num>`
- Router ID spine — `1.2.<pod>.<plane>`
- Router ID ToR — `1.1.<pod>.<num>`
- ASNUM spine — `6520<pod>`
- ASNUM ToR — `6510<pod><num>`

### Environment

- Netbox url: http://localhost:8000/
- Netbox login/password: `annet/annet`
- Device telnet and ssh login/password: `annet/annet`  
- Device mgmt addresses:
   | Router | MGMT |
   |:------:|:----|
   | spine-1-1 | `172.20.0.100	` |
   | spine-1-2 | `172.20.0.101` |
   | tor-1-1 | `172.20.0.102` |
   | tor-1-2 | `172.20.0.103` |
   | tor-1-3 | `172.20.0.104` |

### Mesh

BGP attributes are generated by mesh. Mesh allows assigning attributes to devices, following the connections between them (in Netbox).  
[More about mesh in annet documentation](https://annetutil.github.io/annet/main/mesh/index.html).

### Generators

In this lab, generators are organized within the `./src/lab_generators` directory. The lab utilizes the following generators:

- Hostname
- Interface IP addresses, descriptions and shutdown state
- Route map
- BGP process


#### Hostname generator

The default configuration has basic names like `tor` or `spine`. The generator sets these names to hostnames taken from Netbox.

- [Hostname generator src](./src/lab_generators/hostname.py)

#### Interface descriptions generator

Following the connections in Netbox, the descriptions on the interfaces are created as `remote_hostname@remote_port`.

- [Interface descriptions generator src](./src/lab_generators/description.py)

#### Interface shutdown generator

The generator sets `no shutdown` to every interface on the device.

- [Interface shutdown generator src](./src/lab_generators/shutdown.py)

#### Interface IP addresses generator

The lab has two kinds of IP addresses:

1. IP addresses known from Netbox
2. IP addresses on links between ToRs and spines which are generated by the mesh model

The generator collects the two kinds of addresses and assigns them to the interfaces.

- [generator src](./src/lab_generators/ip_address.py)
- [mesh spine src](./src/lab_generators/mesh_views/spine.py)
- [mesh tor src](./src/lab_generators/mesh_views/tor.py)

#### Route map generator

For BGP, neighbors and `redistribute connected` route-maps are needed, which should be generated before BGP process. An interesting thing to do is to apply `maintenance` tag on a spine, and then drain traffic there. The role is also important for the generator.

- [Route map generator src](./src/lab_generators/rpl.py)

#### BGP process

BGP neighbors also depend on the connections in Netbox, they are generated only if a connection is present. This is supported by the mesh models.

- [generator src](./src/lab_generators/bgp.py)
- [mesh spine src](./src/lab_generators/mesh_views/spine.py)
- [mesh tor src](./src/lab_generators/mesh_views/tor.py)

---

### Lab Guide

**Step 1. Build Annet and Netbox Docker images**

If it was not done yet, build Netbox and Annet docker images:

```bash
cd annetutils/contribs/labs
make build
```

**Step 2. Start the lab**

> NOTE: Do not forget to put Cisco IOS image `c7200-jk9s-mz.124-13a.bin` into `../vm_images` directory.

```bash
make lab10
```

After this step you will be automatically logged in to annet container as a root. You can login manually by `docker exec -u root -t -i annet /bin/bash`.

**Step 3. Enable SSH on Cisco routers by executing the script**

```bash
for ip in 0 1 2 3 4; do netsshsetup -a 172.20.0.10$ip -b ios -l annet -p annet -P telnet -v cisco --ipdomain nh.com; done
```
This script generates 2048 bit RSA keys and enables SSH. It takes a while.

**Step 4. Deploy configuration to devices**

Generate configuration for spine-1-1, spine-1-2, tor-1-1, tor-1-2, tor-1-3:

```bash
annet gen spine-1-1.nh.com spine-1-2.nh.com tor-1-1.nh.com tor-1-2.nh.com tor-1-3.nh.com
```

Look at diff:
```bash
annet diff spine-1-1.nh.com spine-1-2.nh.com tor-1-1.nh.com tor-1-2.nh.com tor-1-3.nh.com
```

Deploy it:
```bash
annet deploy spine-1-1.nh.com spine-1-2.nh.com tor-1-1.nh.com tor-1-2.nh.com tor-1-3.nh.com
```

**Step 5. Change device role in Netbox and deploy configuration**

Go to the [Netbox](http://localhost:8000/dcim/devices/7/), assign `tor-1-1.nh.com` role `Unknown`.

Look at diff:

```bash
annet diff spine-1-1.nh.com spine-1-2.nh.com tor-1-1.nh.com tor-1-2.nh.com tor-1-3.nh.com
```

Deploy it:
```bash
annet deploy spine-1-1.nh.com spine-1-2.nh.com tor-1-1.nh.com tor-1-2.nh.com tor-1-3.nh.com
```

**Step 6. Restore the role and repeat the actions**


**Step 7. Break a connection and check what happens**

Go to [Netbox](http://localhost:8000/dcim/devices/7/), delete the connection between `tor-1-1.nh.com` and `spine-1-1.nh.com`.

Look at diff:
```bash
annet diff spine-1-1.nh.com spine-1-2.nh.com tor-1-1.nh.com tor-1-2.nh.com tor-1-3.nh.com
```

Deploy it:
```bash
annet deploy spine-1-1.nh.com spine-1-2.nh.com tor-1-1.nh.com tor-1-2.nh.com tor-1-3.nh.com
```

**Step 8. Restore the connection and repeat the actions**

**Step 9. Drain traffic from one of the spines**

Go to [Netbox](http://localhost:8000/dcim/devices/5/), assign `spine-1-1.nh.com` tag `maintenance`.

Look at diff:
```bash
annet diff spine-1-1.nh.com spine-1-2.nh.com tor-1-1.nh.com tor-1-2.nh.com tor-1-3.nh.com
```

Deploy it:
```bash
annet deploy spine-1-1.nh.com spine-1-2.nh.com tor-1-1.nh.com tor-1-2.nh.com tor-1-3.nh.com
```

Remove the tag and repeat the actions.

**Step 10. After finishing the lab, stop it**

```bash
make services_stop
```
