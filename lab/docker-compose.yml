networks:
  default:
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 172.20.0.0/24
        gateway: 172.20.0.1
  link:frr:vyos:
    driver: bridge
  link:frr:r1-r2:
    driver: bridge
  link:frr:r2-r3:
    driver: bridge

services:
  netbox:
    ports:
      - 8000:8080
    volumes:
      - ../src/:/home/ubuntu/src
  
  dynamips-lab:
    image: ubuntu:bionic
    tty: true
    volumes:
      - ../dynamips:/home/ubuntu/
      - ../discovery:/home/ubuntu/discovery
    command: sh "/home/ubuntu/install.sh"
    cap_add:
          - net_admin
          - net_raw
          - sys_module
    devices: [/dev/net/tun:/dev/net/tun]
    networks:
      - default

  annet:
    build: ../annet/
    command: tail -f /dev/null
    volumes:
      - ../annet/config.yaml:/config.yaml
      - ../annet/my_generators:/my_generators
      # - type: bind
      #   source: ../annet/config.yaml
      #   target: /config.yaml
      # - type: bind
      #   source: ../annet/my_generators
      #   target: /my_generators
    environment:
      - NETBOX_TOKEN=${NETBOX_TOKEN}
      - NETBOX_URL=${NETBOX_URL}

  # lab-r4.nh.com
  # vyos-r1:
  #   image: afla/vyos:1.4
  #   command: /sbin/init
  #   networks:
  #     - default
  #   ports:
  #   - '2000:22'
  #   privileged: true
  #   volumes:
  #     - /lib/modules:/lib/modules
  #   sysctls:
  #     - net.ipv6.conf.all.disable_ipv6=0

  frr-r1:
    image: frr-debian:latest
    build: ../frr
    privileged: true
    environment:
      HOSTNAME: frr-r1
      FRR_DAEMONS: "zebra bgpd ospfd ldpd"
    command: /install.sh
    tty: true
    networks:
      - default
      - link:frr:r1-r2
  
  frr-r2:
    image: frr-debian:latest
    build: ../frr
    privileged: true
    environment:
      HOSTNAME: frr-r2
      FRR_DAEMONS: "zebra bgpd ospfd ldpd"
    command: /install.sh
    tty: true
    networks:
      - default
      - link:frr:r1-r2
      - link:frr:r2-r3

  frr-r3:
    image: frr-debian:latest
    build: ../frr
    privileged: true
    environment:
      HOSTNAME: frr-r3
      FRR_DAEMONS: "zebra bgpd ospfd ldpd"
    command: /install.sh
    tty: true
    networks:
      - default
      - link:frr:r2-r3
